{% extends "base.html" %}

{% block title %}用户管理{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">用户管理</h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">批量导入用户</h5>
        </div>
        <div class="card-body">
            <form id="importForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">选择Excel文件</label>
                    <input type="file" class="form-control-file" id="file" name="file" accept=".xlsx,.xls">
                </div>
                <button type="submit" class="btn btn-primary">导入</button>
                <button type="button" class="btn btn-secondary" onclick="downloadTemplate()">下载模板</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">用户列表</h5>
        </div>
        <div class="card-body">
            <!-- 添加搜索功能 -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="搜索用户（姓名、用户名、学院）">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="btn-group float-right">
                        <button class="btn btn-primary" type="button" id="filterAll">全部</button>
                        <button class="btn btn-outline-primary" type="button" id="filterStudent">学生</button>
                        <button class="btn btn-outline-primary" type="button" id="filterTeacher">教师</button>
                        <button class="btn btn-outline-primary" type="button" id="filterAdmin">管理员</button>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>姓名</th>
                            <th>学院</th>
                            <th>角色</th>
                            <th>管理员权限</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <!-- 用户数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 全局加载状态控制
window.showLoading = function() {
    document.querySelector('.loading-overlay').style.display = 'flex';
};

window.hideLoading = function() {
    document.querySelector('.loading-overlay').style.display = 'none';
};

// 表格加载状态控制
window.setTableLoading = function(tableId, loading) {
    const table = document.getElementById(tableId);
    if (table) {
        if (loading) {
            table.classList.add('table-loading');
        } else {
            table.classList.remove('table-loading');
        }
    }
};

// 按钮加载状态控制
window.setButtonLoading = function(button, loading) {
    if (loading) {
        button.classList.add('loading');
        button.disabled = true;
        button.setAttribute('data-original-text', button.textContent);
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
    } else {
        button.classList.remove('loading');
        button.disabled = false;
        button.innerHTML = button.getAttribute('data-original-text') || button.innerHTML.replace('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...', '');
    }
};

// 存储所有用户数据
let allUsers = [];
// 当前筛选条件
let currentFilter = 'all';
let currentSearchTerm = '';

document.getElementById('importForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    const formData = new FormData();
    const fileInput = document.getElementById('file');
    
    if (!fileInput.files[0]) {
        alert('请选择要导入的文件');
        setButtonLoading(submitButton, false);
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    
    try {
        const response = await fetch('/api/admin/users/import', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (response.ok) {
            let message = `成功导入 ${result.count} 个用户`;
            if (result.errors && result.errors.length > 0) {
                message += `\n失败 ${result.errors.length} 个`;
                const errorMessages = result.errors.slice(0, 5);
                message += '\n' + errorMessages.join('\n');
                if (result.errors.length > 5) {
                    message += `\n... 等共 ${result.errors.length} 个错误`;
                }
            }
            alert(message);
            loadUsers();  // 重新加载用户列表
        } else {
            alert(result.error || '导入失败');
        }
    } catch (error) {
        console.error('导入失败：', error);
        alert('导入失败：' + (error.message || '未知错误'));
    } finally {
        setButtonLoading(submitButton, false);
        fileInput.value = '';
    }
};

async function loadUsers() {
    setTableLoading('userList', true);
    try {
        const response = await fetch('/api/admin/users', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // 保存所有用户数据
        allUsers = await response.json();
        
        // 应用当前筛选和搜索
        filterAndDisplayUsers();
    } catch (error) {
        console.error('加载用户列表失败：', error);
        alert('加载用户列表失败：' + error.message);
    } finally {
        setTableLoading('userList', false);
    }
}

function filterAndDisplayUsers() {
    // 首先按角色筛选
    let filteredUsers = allUsers;
    if (currentFilter !== 'all') {
        filteredUsers = allUsers.filter(user => user.role === currentFilter);
    }
    
    // 然后应用搜索条件
    if (currentSearchTerm) {
        const searchLower = currentSearchTerm.toLowerCase();
        filteredUsers = filteredUsers.filter(user => 
            (user.username && user.username.toLowerCase().includes(searchLower)) ||
            (user.name && user.name.toLowerCase().includes(searchLower)) ||
            (user.department && user.department.toLowerCase().includes(searchLower))
        );
    }
    
    // 显示筛选后的用户列表
    displayUsers(filteredUsers);
}

function displayUsers(users) {
    const tbody = document.getElementById('userList');
    tbody.innerHTML = users.map(user => {
        const isAdmin = user.role === 'admin';
        return `
            <tr>
                <td>${user.username || ''}</td>
                <td>${user.name || ''}</td>
                <td>${user.department || ''}</td>
                <td>${getRoleText(user.role) || ''}</td>
                <td>
                    <button 
                        class="btn btn-sm ${isAdmin ? 'btn-success' : 'btn-outline-secondary'}" 
                        onclick="toggleAdminRole('${user.username}', ${isAdmin})"
                        data-original-text="${isAdmin ? '取消管理员' : '设为管理员'}"
                    >
                        ${isAdmin ? '取消管理员' : '设为管理员'}
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.username}')">删除</button>
                </td>
            </tr>
        `;
    }).join('');
}

function getRoleText(role) {
    const roleMap = {
        'student': '学生',
        'teacher': '教师',
        'admin': '管理员'
    };
    return roleMap[role] || role;
}

async function toggleAdminRole(username, isCurrentlyAdmin) {
    if (!confirm(`确定要${isCurrentlyAdmin ? '取消' : '设置'}该用户的管理员权限吗？`)) {
        return;
    }
    
    try {
        const button = event.target;
        setButtonLoading(button, true);
        
        const response = await fetch(`/api/admin/users/${username}/toggle-admin`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || '操作失败');
        }
        
        const result = await response.json();
        alert(result.message || '操作成功');
        
        // 重新加载用户列表
        loadUsers();
    } catch (error) {
        console.error('修改管理员权限失败:', error);
        alert('修改管理员权限失败: ' + error.message);
    }
}

async function deleteUser(username) {
    if (!confirm('确定要删除此用户吗？')) return;
    
    const button = event.target;
    setButtonLoading(button, true);
    
    try {
        const response = await fetch(`/api/admin/users/${username}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            await loadUsers();  // 重新加载用户列表
        } else {
            const error = await response.json();
            alert(error.error || '删除失败');
        }
    } catch (error) {
        alert('删除失败：' + error);
    } finally {
        setButtonLoading(button, false);
    }
}

// 添加下载模板的函数
async function downloadTemplate() {
    try {
        const response = await fetch('/api/admin/templates/user-import', {
            method: 'GET',
            headers: {
                'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`下载失败: ${errorText}`);
        }
        
        // 获取文件名
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = '用户导入模板.xlsx';
        if (contentDisposition) {
            const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
            if (matches != null && matches[1]) {
                filename = matches[1].replace(/['"]/g, '');
            }
        }
        
        // 下载文件
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        console.log('Template downloaded successfully');  // 添加调试信息
    } catch (error) {
        console.error('下载模板失败：', error);
        alert('下载模板失败：' + error.message);
    }
}

// 页面加载时获取用户列表
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    
    // 搜索功能
    document.getElementById('searchButton').addEventListener('click', function() {
        currentSearchTerm = document.getElementById('searchInput').value.trim();
        filterAndDisplayUsers();
    });
    
    // 回车键搜索
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            currentSearchTerm = this.value.trim();
            filterAndDisplayUsers();
        }
    });
    
    // 角色筛选功能
    document.getElementById('filterAll').addEventListener('click', function() {
        setActiveFilter(this);
        currentFilter = 'all';
        filterAndDisplayUsers();
    });
    
    document.getElementById('filterStudent').addEventListener('click', function() {
        setActiveFilter(this);
        currentFilter = 'student';
        filterAndDisplayUsers();
    });
    
    document.getElementById('filterTeacher').addEventListener('click', function() {
        setActiveFilter(this);
        currentFilter = 'teacher';
        filterAndDisplayUsers();
    });
    
    document.getElementById('filterAdmin').addEventListener('click', function() {
        setActiveFilter(this);
        currentFilter = 'admin';
        filterAndDisplayUsers();
    });
});

// 设置当前激活的筛选按钮
function setActiveFilter(button) {
    // 移除所有按钮的 active 类
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // 给当前按钮添加 active 类
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-primary');
}
</script>
{% endblock %} 